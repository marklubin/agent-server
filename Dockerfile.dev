# =============================================================================
# Development Dockerfile - includes dev dependencies and hot reload tools
# =============================================================================
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Don't compile bytecode in dev (faster rebuilds)
ENV UV_COMPILE_BYTECODE=0
ENV UV_LINK_MODE=copy

WORKDIR /app

# Install ALL dependencies including dev (watchfiles, debugpy, pytest, etc.)
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project

# Copy source (will be overwritten by volume mount in dev)
COPY src/ ./src/
COPY alembic/ ./alembic/
COPY alembic.ini ./

# Install the project itself
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked

# Add venv to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Reset entrypoint so we can use uv run in commands
ENTRYPOINT []

# Default: run server with reload (overridden in compose)
CMD ["uv", "run", "uvicorn", "kairix_agent.server.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
